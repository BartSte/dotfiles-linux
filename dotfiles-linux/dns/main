#!/usr/bin/env bash

set -euo pipefail
this_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

function setup_network_manager() {
    sudo mkdir -p /etc/NetworkManager/conf.d
    sudo cp -u "$this_dir"/dns.conf /etc/NetworkManager/conf.d/dns.conf
    sudo systemctl restart NetworkManager
}

function setup_resolvconf() {
    if [ "$(systemctl is-enabled systemd-resolved)" != "enabled" ]; then
        echo "Enabling systemd-resolved"
        sudo systemctl enable systemd-resolved.service
    fi

    if [ "$(systemctl is-active systemd-resolved)" == "active" ]; then
        echo "Starting systemd-resolved"
        sudo systemctl start systemd-resolved.service
    fi

    sudo cp -u "$this_dir"/resolved.conf /etc/systemd/resolved.conf
    sudo systemctl restart systemd-resolved.service
    resolvectl status
}

echo "Setting up DNS for blocking adult content"
setup_network_manager
setup_resolvconf
