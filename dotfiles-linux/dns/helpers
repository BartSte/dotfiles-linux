#!/bin/bash

this_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

################################################################################
# Reset NetworkManager and
################################################################################
reset_dns() {
    _reset_network_manager
    _reset_systemd_resolved
}

_reset_network_manager() {
    if [ "$(systemctl is-enabled NetworkManager)" != "enabled" ]; then
        lg "NetworkManager is not enabled. Exiting."
        exit 1
    fi

    lg "Resetting NetworkManager"
    sudo rm -f /etc/NetworkManager/NetworkManager.conf
    sudo touch /etc/NetworkManager/NetworkManager.conf
    echo -e "[main]\nplugins=keyfile" | sudo tee /etc/NetworkManager/NetworkManager.conf >/dev/null

    sudo systemctl start NetworkManager
    while [ "$(systemctl is-active NetworkManager)" != "active" ]; do
        lg "Waiting for NetworkManager to start"
        sleep 1
    done

    lg "Clearing per-connection DNS settings"
    nmcli -t -f NAME connection show | while IFS= read -r conn; do
        nmcli connection modify "$conn" ipv4.dns ""
        nmcli connection modify "$conn" ipv4.ignore-auto-dns no
    done

    lg "NetworkManager reset completed."
}

_reset_systemd_resolved() {
    lg "Resetting systemd-resolved"
    sudo rm -f /etc/systemd/resolved.conf
    sudo touch /etc/systemd/resolved.conf
    sudo ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf
    sudo systemctl restart systemd-resolved
    sudo systemd-resolve --flush-caches
    sudo systemctl disable --now systemd-resolved
    lg "systemd-resolved reset completed."
}

################################################################################
# Replace the /etc/sudoers file with the one at $this_dir/sudoers
################################################################################
update_sudoers() {
    local target backup source
    target="/etc/sudoers"
    backup="/etc/sudoers.bak"
    source="$this_dir/sudoers"

    if [ ! -f "$source" ]; then
        lg "The sudoers file $source does not exist. Exiting."
        exit 1
    fi

    lg "Updating sudoers"
    sudo cp -f "$target" "$backup"
    sudo cp -f "$source" "$target"
    sudo chown root:root "$target"
    sudo chmod 440 "$target"

    if ! sudo visudo -c; then
        lg "The sudoers file is not valid. Restoring the backup."
        sudo cp -f "$backup" "$target"
        exit 1
    fi
}
