#!/usr/bin/env bash
set -euo pipefail

# Ensure Node 25 stays installed; never install nodejs-lts-jod.
want_major=25
lts_pkg="nodejs-lts-jod"

pac() { if [[ $EUID -ne 0 ]]; then sudo pacman "$@"; else pacman "$@"; fi; }

# Refresh and upgrade base
pac -Syu --noconfirm --needed --quiet

# Remove LTS if present
if pac -Qi "$lts_pkg" >/dev/null 2>&1; then
  pac -Rns --noconfirm "$lts_pkg"
fi

# Ensure current Node + npm
pac -S --noconfirm --needed nodejs npm

# Verify Node major
if ! command -v node >/dev/null 2>&1; then
  echo "error: node missing after install" >&2; exit 1
fi
maj="$(node -v | sed -E 's/^v([0-9]+).*/\1/')"
if [[ "$maj" != "$want_major" ]]; then
  echo "error: Node major=$maj, expected $want_major" >&2; exit 1
fi

# Resolve each argument to its canonical package NAME (no version operators)
# If resolution fails, fall back to the raw token stripped of any =<> constraint.
resolve_name() {
  local token="$1"
  if pac -Sp --print-format %n -- "$token" >/dev/null 2>&1; then
    pac -Sp --print-format %n -- "$token" 2>/dev/null
  else
    printf '%s\n' "$token" | sed 's/[<>=].*$//'
  fi
}

# Build filtered install set
declare -a filtered=()
declare -a skipped=()

for token in "$@"; do
  name="$(resolve_name "$token")"

  # Skip explicit LTS
  if [[ "$name" == "$lts_pkg" ]]; then
    skipped+=("$token")
    continue
  fi

  # Skip any package whose dependency tree requires the LTS
  if pactree -s -- "$name" 2>/dev/null | grep -Fxq "$lts_pkg"; then
    skipped+=("$token")
    continue
  fi

  filtered+=("$token")
done

# Install remaining targets non-interactively
if [[ ${#filtered[@]} -gt 0 ]]; then
  pac -S --noconfirm --needed -- "${filtered[@]}"
fi

# Report what was skipped, exit 2 if anything skipped
if [[ ${#skipped[@]} -gt 0 ]]; then
  echo "warning: skipped packages requiring or equal to $lts_pkg:" >&2
  printf ' - %s\n' "${skipped[@]}" >&2
  exit 2
fi

echo "ok: Node $(node -v) installed. Remaining packages installed without $lts_pkg."

