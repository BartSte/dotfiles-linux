#!/bin/bash

usage="Usage: $(basename "$0") [-q | --quiet] [-v | --verbose] [-h | --help] <davmail-config> <org file> <khalorg list arg>

Sychronize all \`vdirsyncer\` calendars and export them to org with \`khalorg\`.
Davmail is used as the CalDav server. If it is not already running, it will be
activated temporarly.

where:
options
-q --quiet  suppress /dev/stderr and /dev/stdout
-v --verbose  also log to /dev/stderr
-h --help   shows this help messages

positional
<davmail-config>        your davmailconfig
<org file>              the output file
<khalorg list arg>    see \`khalorg list -h\`
"
state_dir="${XDG_STATE_HOME:-$HOME/.local/state}"
mkdir -p "$state_dir"
log_file="$state_dir/calsync.log"
if [[ -f $log_file ]]; then
    size=$(wc -c < "$log_file")
    if (( size > 1048576 )); then
        tail -c 1048576 "$log_file" > "$log_file.tmp" && mv "$log_file.tmp" "$log_file"
    fi
fi
error="$log_file"
output=/dev/stdout
verbose=0
options=$(getopt -o qvh --long quiet,verbose,help -- "$@")

[ $? -eq 0 ] || {
    echo "Incorrect options provided"
    exit 1
}

eval set -- "$options"
while true; do
    case "$1" in
    -q | --quiet)
        output=/dev/null
        error=/dev/null
        shift
        ;;
    -v | --verbose)
        verbose=1
        shift
        ;;
    -h | --help)
        echo "$usage"
        exit
        ;;
    --)
        shift
        break
        ;;
    *)
        echo "Internal error"
        exit 1
        ;;
    esac
done

if [[ $output != /dev/null && $error != /dev/null && $verbose -eq 1 ]]; then
    error=>(tee -a "$log_file" >&2)
fi

[ $# -eq 0 ] && {
    echo "$usage"
    exit
}
[ $# -lt 5 ] && {
    echo "Missing positional arguments"
    exit
}

davmailconfig=$1
orgfile=$2
shift 2
khalorg=$@

##############################################################################
# This function is the main function of the script. It checks if the user is
# logged in, if there is an internet connection, starts davmail, runs the
# synchronization and kills davmail afterwards.
##############################################################################
main() {
    is_logged_in || {
        echo "$USER not logged in; sync will not run."
        exit
    }
    has_internet || {
        echo "No internet connection detected."
        exit
    }
    start_davmail
    vdirsyncer -v CRITICAL sync || {
        echo "vdirsyncer failed"
        kill_davmail
        exit
    }
    khalorg_list || {
        echo "khalorg failed"
        kill_davmail
        exit
    }
    kill_davmail
    echo 'Calendar sync done.'
}

##############################################################################
# This function checks if the user is logged in. It does so by checking if the
# user has a process with the same name as the user id.
##############################################################################
is_logged_in() {
    pgrep -u "${USER:=$LOGNAME}" >/dev/null
}

##############################################################################
# This function checks if the user has an internet connection. It does so by
# pinging a known ip address.
##############################################################################
has_internet() {
    ping -q -c 1 1.1.1.1 >/dev/null
}

##############################################################################
# This function starts davmail if it is not already running. It does so by
# checking if there is a process with the name 'davmail.jar'.
##############################################################################
start_davmail() {
    pgrep -f davmail\.jar && return
    davmail "$davmailconfig" &
    pid_davmail=$!
    sleep 0.5
}

##############################################################################
# This function kills davmail if it is running. It does so by checking if there
# is a process with the name 'davmail.jar'.
##############################################################################
kill_davmail() {
    [[ $pid_davmail ]] && kill $pid_davmail
}

##############################################################################
# This function runs khalorg list.
##############################################################################
khalorg_list() {
    khalorg list $khalorg >$orgfile
}

#############################################################################
# This function is used to display a message in a tmux session. The message can
# be provided as an argument, or through stdin. If tmux is not running, the
# message will be printed to stderr.
##############################################################################
tmux_display() {
    msg=${1:-$(cat)}
    if [[ $TMUX ]]; then
        tmux display -p -d 2000 "$msg" >&2
    else
        echo "$msg" >&2
    fi
}

##############################################################################
# Execute the main function. If the script is run in a tmux session, the output
# will be displayed in a tmux message.
##############################################################################
tmux_display "Calendar sync started"
if [[ $output == /dev/null && $error == /dev/null ]]; then
    main 1>/dev/null 2>/dev/null | tmux_display
elif [[ $verbose -eq 1 ]]; then
    main 1>"$output" 2> >(tee -a "$log_file" >&2) | tmux_display
else
    main 1>"$output" 2>"$error" | tmux_display
fi
