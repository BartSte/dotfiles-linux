#!/usr/bin/env bash
set -euo pipefail

usage() {
    cat <<'EOF'
Usage: wpy [options] <command>

Run a Windows Python from WSL. If WINPY cannot be resolved, it is an error.

WINPY Path to python.exe

Options:
  --wpy-help   Show help and exit
  --wpy-path   Print resolved python.exe and exit
  --wpy-debug  Log debug to stderr
EOF

}

# ---------- flags ----------
debug=/dev/null
mode="run" # run | path | dir
argv=()

while [[ $# -gt 0 ]]; do
    case "$1" in
    --wpy-help)
        usage
        exit 0
        ;;
    --wpy-path) mode="path" ;;
    --wpy-debug) debug=/dev/stderr ;;
    *) argv+=("$1") ;;

    esac
    shift
done

# ---------- guards ----------
if ! grep -qi microsoft /proc/version 2>/dev/null; then
    echo "Not running in WSL" >"$debug"
    exit 1
fi

# ---------- resolve python.exe ----------
py="${WINPY:-}"
if [[ -z "$py" ]]; then
    echo "WINPY is not set" >/dev/stderr
    exit 1
elif [[ ! -e "$py" ]]; then
    echo "Failed to resolve $py" >/dev/stderr
    exit 1
fi

# ---------- output modes ----------
case "$mode" in
path)
    echo "$py"
    exit 0
    ;;
esac

# ---------- execute ----------
# Call Windows python.exe with original arguments
exec "$py" "${argv[@]}"
