#!/bin/bash

usage="Usage: $(basename "$0") [-h | --help] [-v | --verbose] <davmail-config> 

Sychronize all \`mbsyncer\` channels and index them with \`notmuch\` using an
imap connection with \`davmail\`. If no davmail config is provided, ignore
davmail, and only run \`mbsyncer\` and \`notmuch\`.

where:
    options
    -q --quiet  suppress /dev/stderr and /dev/stdout 
    -v --verbose  also log to /dev/stderr
    -h --help   shows this help messages

    positional
    <davmail-config> your davmailconfig"

state_dir="${XDG_STATE_HOME:-$HOME/.local/state}"
mkdir -p "$state_dir"
log_file="$state_dir/mailsync.log"
if [[ -f $log_file ]]; then
    size=$(wc -c <"$log_file")
    if ((size > 1048576)); then
        tail -c 1048576 "$log_file" >"$log_file.tmp" && mv "$log_file.tmp" "$log_file"
    fi
fi
error="$log_file"
output=/dev/stdout
verbose=0
use_verbose_tee=0
options=$(getopt -o qvh --long quiet,verbose,help -- "$@")

[ $? -eq 0 ] || {
    echo "Incorrect options provided"
    exit 1
}

eval set -- "$options"
while true; do
    case "$1" in
    -q | --quiet)
        output=/dev/null
        error=/dev/null
        shift
        ;;
    -v | --verbose)
        verbose=1
        shift
        ;;
    -h | --help)
        echo "$usage"
        exit 0
        ;;
    --)
        shift
        break
        ;;
    *)
        echo "Internal error"
        exit 1
        ;;
    esac
done

if [[ $output != /dev/null && $error != /dev/null && $verbose -eq 1 ]]; then
    use_verbose_tee=1
fi

[[ $1 ]] && davmailconfig=$1

##############################################################################
# This function is the main function of the script. It checks if the user is
# logged in, if there is an internet connection, starts davmail, runs the
# synchronization and kills davmail afterwards.
##############################################################################
main() {
    is_logged_in || {
        echo "$USER not logged in; sync will not run."
        exit 1
    }
    has_internet || {
        echo "No internet connection detected."
        exit 1
    }
    start_davmail
    start_mbsyncer
    start_notmuch
    kill_davmail
}

##############################################################################
# This function checks if the user is logged in. It does so by checking if the
# user has a process with the same name as the user id.
##############################################################################
is_logged_in() {
    pgrep -u "${USER:=$LOGNAME}" >/dev/null
}

##############################################################################
# This function checks if the user has an internet connection. It does so by
# pinging a known ip address.
##############################################################################
has_internet() {
    ping -q -c 1 1.1.1.1 >/dev/null
}

##############################################################################
# This function starts davmail if it is not already running. It does so by
# checking if there is a process with the name 'davmail.jar'.
##############################################################################
start_davmail() {
    if [[ -z $davmailconfig ]]; then
        return
    elif pgrep -f davmail\.jar; then
        echo "davmail is already running."
        return
    else
        davmail "$davmailconfig" &
        pid_davmail=$!
        sleep 1
    fi
}

##############################################################################
# This function starts mbsyncer if it is not already running. It does so by
# checking if there is a process with the name 'mbsync'.
##############################################################################
start_mbsyncer() {
    pgrep -x mbsync && {
        echo "mbsync is already running."
        kill_davmail
        exit 0
    }
    mbsync -a -q -q || {
        echo 'Email sync failed.'
        kill_davmail
        exit 1
    }
}

##############################################################################
# This function starts notmuch if it is not already running. It does so by
# checking if there is a process with the name 'notmuch'.
##############################################################################
start_notmuch() {
    pgrep -x notmuch && {
        echo "notmuch is already running."
        kill_davmail
        exit 0
    }
    notmuch new --quiet || {
        echo 'Email sync failed.'
        kill_davmail
        exit 1
    }
}

##############################################################################
# This function kills davmail if it is running. It does so by checking if there
# is a process with the name 'davmail.jar'.
##############################################################################
kill_davmail() {
    if [[ -z $davmailconfig ]]; then
        return
    elif [[ -n $pid_davmail ]]; then
        kill "$pid_davmail"
    elif pgrep -f davmail\.jar; then
        pkill -f davmail\.jar
    fi
}

##############################################################################
# This function starts the main function of the script. It does so by checking
# if the script is running in a tmux session. If so, it displays the start
# message in the tmux status bar. If not, it prints the start message to the
# terminal.
##############################################################################
if [[ $TMUX ]]; then
    tmux display -d 1000 'email sync started'
fi
message='email sync done'
if [[ $use_verbose_tee -eq 1 ]]; then
    main 2> >(tee -a "$log_file" >&2) 1>>"$output" || message="email sync failed with exit code $?"
else
    main 2>>"$error" 1>>"$output" || message="email sync failed with exit code $?"
fi
if [[ $TMUX ]]; then
    tmux display -d 2000 "$message"
fi
