#!/usr/bin/env bash

set -eou pipefail

# Use to checkout stdou of pinentry
# pinentry-curses "$@" 2>&1 | tee /tmp/pinentry.log

command_exists() {
    command -v "$1" >/dev/null 2>&1
}

get_caller() {
    ps -o comm= -p $PPID
}

make_pinentry_output() {
    echo "OK Pleased to meet you"
    echo "D $(rbw get gpg)"
    echo "OK"
}

check() {
    command_exists rbw && rbw unlock
}

logdir=/tmp/pinentry-custom
mkdir -p $logdir
get_caller >>$logdir/pinentry-caller

if check; then
    make_pinentry_output 
else
    pinentry "$@"
fi
