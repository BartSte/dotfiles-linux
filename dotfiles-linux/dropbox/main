#!/bin/bash
set -euo pipefail

# Copied from the Arch Wiki: https://wiki.archlinux.org/title/dropbox
# Since at least version 2.4.6 (see comments around 2013-11-06 on AUR), Dropbox
# has had an auto-update capability which downloads a new binary to the
# ~/.dropbox-dist/ folder. The service then attempts to hand over control to
# this binary and dies, causing systemd to re-start the service, generating a
# conflict and an endless loop of log-filling, CPU-eating misery. A workaround
# is to prevent Dropbox from downloading the automatic update by
# creating the ~/.dropbox-dist/ folder and making it read-only.
disable_auto_update() {
    rm -rf ~/.dropbox-dist || true
    install -dm0 ~/.dropbox-dist
}

systemctl --user enable dropbox && systemctl --user start dropbox
disable_auto_update
