#!/usr/bin/env bash

# Ensure dotfiles helper scripts are available when running non-interactively
export PATH="${HOME}/dotfiles-linux/bin:${PATH}"

display_help() {
    cat <<EOF
Usage: ${0##*/} [OPTION]
Authenticate vdirsyncer via davmail and sync calendars.

Options:
  -h, --help    Show this help message
EOF
}

confirm_action() {
    read -p "$1 (y/n) " -n 1 -r
    echo
    [[ $REPLY =~ ^[Yy]$ ]]
}

cleanup_davmail() {
    if [[ -n "${DAVMAIL_PID:-}" ]]; then
        kill "$DAVMAIL_PID" 2>/dev/null || true
        unset DAVMAIL_PID
    fi
}

get_prop() {
    # Usage: get_prop <file> <key>
    local file="$1" key="$2"
    awk -F= -v k="$key" '
        $0 ~ "^[[:space:]]*#" { next }
        $1 ~ "^[[:space:]]*"k"[[:space:]]*$" {
            sub(/^[[:space:]]+/, "", $2)
            sub(/[[:space:]]+$/, "", $2)
            print $2
            exit
        }
    ' "$file"
}

wait_for_port() {
    # Usage: wait_for_port <port> [timeout_seconds]
    local port="$1" timeout="${2:-20}"
    local i
    for ((i = 0; i < timeout; i++)); do
        (echo >"/dev/tcp/127.0.0.1/${port}") >/dev/null 2>&1 && return 0
        sleep 1
    done
    return 1
}

run_davmail() {
    # Start davmail temporarily in the background for a specific config file.
    local config="$1"
    local cfg_path="${HOME}/.config/davmail/${config}"

    if [[ ! -f "$cfg_path" ]]; then
        echo "Missing DavMail config: $cfg_path" >&2
        return 1
    fi

    local caldav_port
    caldav_port="$(get_prop "$cfg_path" "davmail.caldavPort")"
    caldav_port="${caldav_port:-1080}"

    echo "Starting DavMail with $cfg_path (CalDAV port ${caldav_port})..."
    davmail "$cfg_path" &
    DAVMAIL_PID=$!

    if ! wait_for_port "$caldav_port" 20; then
        echo "DavMail didn't open port ${caldav_port} in time. Check /tmp/davmail.log" >&2
        return 1
    fi
}

PROMPT="This script authenticates vdirsyncer using DavMail and then syncs calendars.

It will start DavMail temporarily in the background for each config file, run:
  - vdirsyncer discover
  - vdirsyncer sync

If DavMail needs authentication, it will print a Microsoft login URL and ask for a code in this terminal."

main() {
    case "$1" in
    -h | --help)
        display_help
        exit 0
        ;;
    *)
          if confirm_action "$PROMPT"; then
              trap cleanup_davmail EXIT INT TERM
              run_davmail "davmail.work.properties"
              vdirsyncer discover outlook_work
              vdirsyncer sync outlook_work
              cleanup_davmail

              run_davmail "davmail.personal.properties"
              vdirsyncer discover outlook_personal
              vdirsyncer sync outlook_personal
              cleanup_davmail
          fi
        ;;
    esac
}

main "$@"
