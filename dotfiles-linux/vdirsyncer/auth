#!/usr/bin/env bash

display_help() {
    cat <<EOF
Usage: ${0##*/} [OPTION]
Authenticate vdirsyncer via davmail and sync calendars.

Options:
  -h, --help    Show this help message
EOF
}

confirm_action() {
    read -p "$1 (y/n) " -n 1 -r
    echo
    [[ $REPLY =~ ^[Yy]$ ]]
}

cleanup_davmail() {
    if [[ -n "${DAVMAIL_PID:-}" ]]; then
        kill "$DAVMAIL_PID" 2>/dev/null || true
        unset DAVMAIL_PID
    fi
}

run_davmail() {
    local config="$1"
    alacritty -e bash -c "davmail ${HOME}/.config/davmail/${config}" &
    DAVMAIL_PID=$!
    sleep 3
}

PROMPT="This script tries to authenticate for vdirsyncer using
davmail. It will open a new shell where davmail is executed. Next, in this
shell, 'vdirsyncer discover' and 'vdirsyncer sync' will be called for each
calendar pair. If davmail is not yet authenticated, it will provide you with
an instruction for authentication."

main() {
    case "$1" in
    -h | --help)
        display_help
        exit 0
        ;;
    *)
          if confirm_action "$PROMPT"; then
              trap cleanup_davmail EXIT INT TERM
              run_davmail "davmail.work.properties"
              vdirsyncer discover outlook_work
              vdirsyncer sync outlook_work
              cleanup_davmail

              run_davmail "davmail.personal.properties"
              vdirsyncer discover outlook_personal
              vdirsyncer sync outlook_personal
              cleanup_davmail
          fi
        ;;
    esac
}

main "$@"
