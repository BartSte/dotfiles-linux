#!/bin/bash
#
# 

#TODO: docs + make similar one for vdirsyncer

sync(){
    check
    start_davmail
    start_mbsyncer
    kill_davmail
    echo 'Email sync done.'
}

check() {
    # Run only if user logged in (prevents systemd errors)
    pgrep -u "${USER:=$LOGNAME}" >/dev/null || { echo "$USER not logged in; sync will not run."; exit ;}

    # Checks for internet connection and set notification script.
    ping -q -c 1 1.1.1.1 > /dev/null || { echo "No internet connection detected."; exit ;}
}

start_davmail() {
    pgrep -f davmail >/dev/null || davmail $HOME/.config/davmail/davmail.properties &
    sleep 2
}

start_mbsyncer() {
    pgrep -x mbsync >/dev/null && { echo "mbsync is already running." ; kill_davmail; exit ;}
    mbsync -a -q -q || { echo 'Email sync failed.'; kill_davmail; exit ;}
}

kill_davmail() {
    kill $(pgrep -f davmail)
}

start_message='Email sync started'
if [[ -z $TMUX ]]; then
    echo "$start_message"
    sync 
else
    tmux display -d 1000 "$start_message"
    tmux display -d 2000 "$(sync)"
fi
