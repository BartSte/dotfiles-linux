#!/bin/bash

usage="Usage: $(basename "$0") [-h | --help] <davmail-config> 

Sychronize all \`mbsyncer\` channels and index them with \`notmuch\` using an imap connection with \`davmail\`.

where:
    options
    -h --help   shows this help messages

    positional
    <davmail-config> your davmailconfig"

options=$(getopt -o h --long help -- "$@")

[ $? -eq 0 ] || { echo "Incorrect options provided"; exit 1; }

eval set -- "$options"
while true; do
    case "$1" in
    -h | --help)
        echo "$usage"
        exit
        ;;
    --)
        shift
        break
        ;;
    esac
    shift
done

[ $# -eq 0 ] && { echo "$usage"; exit ;}
davmailconfig="$1"

main(){
    is_logged_in || { echo "$USER not logged in; sync will not run."; exit ;}
    has_internet || { echo "No internet connection detected."; exit ;}    
    start_davmail
    start_mbsyncer
    start_notmuch
    [[ $pid_davmail ]] && kill $pid_davmail
    echo 'Email sync done.'
}

start_davmail() {
    pgrep -f davmail\.jar >/dev/null && return
    davmail $davmailconfig &
    pid_davmail=$!
    sleep 0.5
}

start_mbsyncer() {
    pgrep -x mbsync >/dev/null && { echo "mbsync is already running." ; kill_davmail; exit ;}
    mbsync -a -q -q || { echo 'Email sync failed.'; kill_davmail; exit ;}
}

start_notmuch() {
    pgrep -x notmuch >/dev/null && { echo "notmuch is already running." ; kill_davmail; exit ;}
    notmuch new --quiet 2>/dev/null || { echo 'Email sync failed.'; kill_davmail; exit ;}
}

start_message='Email sync started'
if [[ $TMUX ]]; then
    tmux display -d 1000 "$start_message"
    tmux display -d 2000 "$(main)"
else
    echo "$start_message"
    main 
fi

