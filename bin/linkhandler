#!/usr/bin/env bash

show_usage() {
    cat <<EOF
Usage: $0 <link>
Opens a link in a preferred program.

The option -w, --win can be used to convert all windows paths to wsl paths. 
This is useful when you want to open a windows file in wsl.

Options:
    -h, --help      Show this message and exit.
    -w, --win       Convert windows paths to wsl paths, by default this is not
                    done. If wsl is not running, this fails and is ignored.
    -d, --debug     Show debug messages in stdout.
EOF
}

is_url() {
    [[ $(echo $1 | grep "://") ]]
}

is_python() {
    [[ $1 =~ .*\.py[:]* ]]
}

open_python() {
    local link=$1
    local pane=0
    local window=0

    local file=$(echo $link | cut -d ':' -f 1)
    local line=$(echo $link | cut -d ':' -f 2 -s) # -s ensures nothing is returned if ':' is not found

    echo "Opening python file: $file" >$debug
    echo "Python file line: $line" >$debug

    tvim -w $window -p $pane -l $line $file
}

# Check if tmux is running
[[ -z "$TMUX" ]] && {
    echo "tmux is not running."
    exit 1
}

# Check for options
win=false
debug=/dev/null
while [[ $# -gt 0 ]]; do
    case $1 in
        -h | --help)
            show_usage
            exit 0
            ;;
        -w | --win)
            win=true
            ;;
        -d | --debug)
            debug=/dev/stdout
            ;;
        *)
            link=$1
            ;;
    esac
    shift
done

echo "Opening link: $link" >$debug

# If the link is a url, open it in the browser and exit.
if is_url $link; then
    echo 'Url detected, opening in browser.' >$debug
    $BROWSER $1 &>/dev/null &
    exit 0
fi

# Convert windows paths to wsl paths
if $win && $(which wslpath &> '/dev/null'); then
    echo 'Converting windows paths to wsl paths.' >$debug
    linkwin=$(wslpath -u $link) || {
        echo "Failed to convert windows path to wsl path: $link" >$debug
        exit 1
    }
    link=$linkwin
fi

if is_python $link; then
    echo "Opening python file: $link" >$debug
    open_python $link
else
    tmux display-message -d 2000 "No handler for $link."
fi
